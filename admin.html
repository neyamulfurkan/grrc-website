<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Admin Login - GSTU Robotics & Research Club">
    <title>Admin Login - GSTU Robotics & Research Club</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        /* Subtle Background Gradient Orbs */
        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            pointer-events: none;
            animation: float 20s infinite ease-in-out;
        }

        .orb-1 {
            width: 500px;
            height: 500px;
            background: rgba(102, 126, 234, 0.4);
            top: -10%;
            left: -10%;
            animation-delay: 0s;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: rgba(118, 75, 162, 0.4);
            bottom: -10%;
            right: -10%;
            animation-delay: 5s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        /* Login Container */
        .login-container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 420px;
            margin: 2rem;
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Login Card */
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        /* Login Header */
        .login-header {
            padding: 3rem 2.5rem 2rem;
            text-align: center;
            background: white;
        }

        .logo {
            width: 70px;
            height: 70px;
            margin: 0 auto 1.25rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .login-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .login-header p {
            font-size: 0.95rem;
            color: #718096;
            font-weight: 500;
        }

        /* Login Form */
        .login-form {
            padding: 2rem 2.5rem 2.5rem;
            background: white;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.625rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.875rem;
            letter-spacing: 0.3px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 1.125rem;
            transition: color 0.2s ease;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.9375rem;
            background: #f7fafc;
            color: #2d3748;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .form-control:hover {
            border-color: #cbd5e0;
            background: #fff;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control:focus + .password-toggle,
        .form-control:focus ~ .input-icon {
            color: #667eea;
        }

        .form-control.error {
            border-color: #fc8181;
            background: #fff5f5;
        }

        /* Password Toggle */
        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 1.125rem;
            padding: 0.375rem;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .password-toggle:hover {
            color: #667eea;
            background: #f7fafc;
        }

        /* Alert Messages */
        .alert {
            padding: 0.875rem 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 0.625rem;
            animation: slideDown 0.3s ease;
        }

        .alert.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
        }

        .alert-success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }

        .alert-icon {
            font-size: 1.125rem;
        }

        /* Remember Me */
        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .remember-me input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 0.625rem;
            cursor: pointer;
            accent-color: #667eea;
            border-radius: 4px;
        }

        .remember-me label {
            font-size: 0.875rem;
            color: #4a5568;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
        }

        /* Login Button */
        .btn-login {
            width: 100%;
            padding: 0.9375rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-login:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-login:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .btn-login .spinner {
            display: none;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin: 0 auto;
        }

        .btn-login.loading .spinner {
            display: block;
        }

        .btn-login.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Footer */
        .login-footer {
            padding: 1.5rem 2.5rem;
            background: #f7fafc;
            text-align: center;
            border-top: 1px solid #e2e8f0;
        }

        .login-footer p {
            margin: 0;
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .login-footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s ease;
        }

        .login-footer a:hover {
            color: #764ba2;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .login-container {
                margin: 1rem;
            }

            .login-header {
                padding: 2.5rem 1.75rem 1.5rem;
            }

            .login-header h1 {
                font-size: 1.5rem;
            }

            .login-header p {
                font-size: 0.875rem;
            }

            .login-form {
                padding: 1.75rem 1.75rem 2rem;
            }

            .logo {
                width: 60px;
                height: 60px;
                font-size: 1.75rem;
            }

            .form-control {
                font-size: 0.875rem;
                padding: 0.8125rem 0.875rem 0.8125rem 2.75rem;
            }

            .btn-login {
                padding: 0.875rem 1.25rem;
                font-size: 0.875rem;
            }
        }

        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Loading State Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Background Orbs -->
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Container -->
    <div class="login-container">
        <div class="login-card">
            <!-- Login Header -->
            <div class="login-header">
                <div class="logo" role="img" aria-label="GSTU Robotics Club Logo">ü§ñ</div>
                <h1>Admin Login</h1>
                <p>GSTU Robotics & Research Club</p>
            </div>

            <!-- Login Form -->
            <form class="login-form" id="loginForm" autocomplete="off" novalidate>
                <!-- Hidden decoy fields for security -->
                <input type="text" name="fake_username" class="visually-hidden" tabindex="-1" autocomplete="off" aria-hidden="true">
                <input type="password" name="fake_password" class="visually-hidden" tabindex="-1" autocomplete="off" aria-hidden="true">
                
                <!-- Alert Message -->
                <div class="alert alert-error" id="alertMessage" role="alert">
                    <span class="alert-icon" aria-hidden="true">‚ö†Ô∏è</span>
                    <span id="alertText">Invalid credentials. Please try again.</span>
                </div>

                <!-- Username Field -->
                <div class="form-group">
                    <label for="username">Username</label>
                    <div class="input-wrapper">
                        <span class="input-icon" aria-hidden="true">üë§</span>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            class="form-control" 
                            placeholder="Enter your username"
                            autocomplete="off"
                            autocorrect="off"
                            autocapitalize="off"
                            spellcheck="false"
                            required
                            aria-required="true"
                            aria-label="Username"
                        >
                    </div>
                </div>

                <!-- Password Field -->
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-wrapper">
                        <span class="input-icon" aria-hidden="true">üîí</span>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-control" 
                            placeholder="Enter your password"
                            autocomplete="new-password"
                            autocorrect="off"
                            autocapitalize="off"
                            spellcheck="false"
                            required
                            aria-required="true"
                            aria-label="Password"
                        >
                        <button 
                            type="button" 
                            class="password-toggle" 
                            id="passwordToggle" 
                            aria-label="Toggle password visibility"
                        >
                            <span aria-hidden="true">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>

                <!-- Remember Me -->
                <div class="remember-me">
                    <input 
                        type="checkbox" 
                        id="rememberMe" 
                        name="rememberMe"
                        aria-label="Remember me on this device"
                    >
                    <label for="rememberMe">Remember me on this device</label>
                </div>

                <!-- Login Button -->
                <button type="submit" class="btn-login" id="loginButton">
                    <span class="btn-text">Sign In</span>
                    <div class="spinner" aria-hidden="true"></div>
                </button>
            </form>

            <!-- Login Footer -->
            <div class="login-footer">
                <p>Not an admin? <a href="index.html">Return to Homepage</a></p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
        <script src="js/api-client.js"></script>
    
    <!-- ‚úÖ Community Chat Toggle Button -->
    <a href="community.html" 
       class="community-chat-toggle" 
       id="communityChatToggle" 
       aria-label="Community Chat"
       title="Join Community Chat"
       style="position: fixed; bottom: 90px; right: 100px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4); display: flex; align-items: center; justify-content: center; color: white; z-index: 999; text-decoration: none; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
            <circle cx="12" cy="10" r="1.5"/>
            <circle cx="8" cy="10" r="1.5"/>
            <circle cx="16" cy="10" r="1.5"/>
        </svg>
        <span style="position: absolute; top: -4px; left: -4px; background: #ef4444; color: white; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">Chat</span>
    </a>
    
    <style>
    .community-chat-toggle:hover {
        transform: scale(1.1) rotate(-5deg);
        box-shadow: 0 12px 32px rgba(16, 185, 129, 0.5);
    }
    .community-chat-toggle:active {
        transform: scale(0.95);
    }
    @media (max-width: 768px) {
        .community-chat-toggle {
            bottom: 80px !important;
            right: 90px !important;
            width: 56px !important;
            height: 56px !important;
        }
    }
    @media (max-width: 480px) {
        .community-chat-toggle {
            bottom: 80px !important;
            right: 85px !important;
            width: 52px !important;
            height: 52px !important;
        }
    }
    </style>
    
    <script>
        'use strict';

        /**
         * Professional Admin Login System
         * Production-ready authentication with proper error handling
         */

        (function() {
            // DOM Elements
            const elements = {
                form: document.getElementById('loginForm'),
                username: document.getElementById('username'),
                password: document.getElementById('password'),
                rememberMe: document.getElementById('rememberMe'),
                passwordToggle: document.getElementById('passwordToggle'),
                loginButton: document.getElementById('loginButton'),
                alertMessage: document.getElementById('alertMessage'),
                alertText: document.getElementById('alertText'),
                loadingOverlay: document.getElementById('loadingOverlay')
            };

            // Configuration
            const config = {
                maxRetries: 20,
                retryDelay: 200,
                sessionDuration: 24, // hours
                redirectDelay: 800,
                storageVerificationAttempts: 10,
                storageVerificationDelay: 100
            };

            // State
            let isInitialized = false;

            /**
             * Initialize application
             */
            function init() {
                console.log('üöÄ Initializing Admin Login System...');
                waitForAPIClient();
            }

            /**
             * Wait for API client to load
             */
            function waitForAPIClient(attempt = 0) {
                if (window.apiClient && typeof window.apiClient.login === 'function') {
                    console.log('‚úÖ API Client ready');
                    setupEventListeners();
                    checkExistingSession();
                    loadRememberedUsername();
                    isInitialized = true;
                    console.log('‚úÖ Login system initialized');
                } else if (attempt < config.maxRetries) {
                    setTimeout(() => waitForAPIClient(attempt + 1), config.retryDelay);
                } else {
                    showAlert('error', 'Failed to load authentication system. Please refresh the page.');
                    elements.loginButton.disabled = true;
                    console.error('‚ùå API Client failed to load');
                }
            }

            /**
             * Setup event listeners
             */
            function setupEventListeners() {
                // Form submission
                elements.form.addEventListener('submit', handleSubmit);

                // Password toggle
                elements.passwordToggle.addEventListener('click', togglePassword);

                // Input validation
                elements.username.addEventListener('input', () => clearFieldError(elements.username));
                elements.password.addEventListener('input', () => clearFieldError(elements.password));

                // Prevent autofill
                setTimeout(() => {
                    elements.username.value = elements.username.value;
                    elements.password.value = '';
                }, 100);
            }

            /**
             * Check for existing valid session
             */
            function checkExistingSession() {
                try {
                    const token = localStorage.getItem('grrc_auth_token');
                    const session = sessionStorage.getItem('adminSession');

                    if (!token || !session) return;

                    const sessionData = JSON.parse(session);
                    const sessionTime = new Date(sessionData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - sessionTime) / (1000 * 60 * 60);

                    if (hoursDiff < config.sessionDuration && sessionData.hasToken) {
                        console.log('‚úÖ Valid session found');
                        redirect();
                    } else {
                        clearSession();
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                    clearSession();
                }
            }

            /**
             * Load remembered username
             */
            function loadRememberedUsername() {
                const remembered = localStorage.getItem('rememberedAdmin');
                if (remembered) {
                    elements.username.value = remembered;
                    elements.rememberMe.checked = true;
                    elements.password.focus();
                }
            }

            /**
             * Handle form submission
             */
            async function handleSubmit(e) {
                e.preventDefault();

                const username = elements.username.value.trim();
                const password = elements.password.value;

                // Validation
                if (!username) {
                    showAlert('error', 'Please enter your username');
                    setFieldError(elements.username);
                    elements.username.focus();
                    return;
                }

                if (!password) {
                    showAlert('error', 'Please enter your password');
                    setFieldError(elements.password);
                    elements.password.focus();
                    return;
                }

                await performLogin(username, password);
            }

            /**
             * Perform login operation
             */
            async function performLogin(username, password) {
                console.log('üîê Starting authentication...');

                setLoadingState(true);
                hideAlert();

                try {
                    // Call login API
                    const result = await window.apiClient.login(username, password);

                    if (!result.success || !result.data || !result.data.token) {
                        throw new Error(result.error || 'Authentication failed');
                    }

                    console.log('‚úÖ Authentication successful');

                    // Save authentication data
                    await saveAuthData(result.data, username);

                    // Verify storage
                    const verified = await verifyStorage(result.data.token);
                    
                    if (!verified) {
                        throw new Error('Failed to persist authentication data');
                    }

                    // Handle remember me
                    handleRememberMe(username);

                    // Show success and redirect
                    showAlert('success', 'Login successful! Redirecting...');
                    console.log('üöÄ Redirecting...');

                    setTimeout(redirect, config.redirectDelay);

                } catch (error) {
                    console.error('‚ùå Login error:', error);
                    handleLoginError(error);
                    setLoadingState(false);
                    elements.password.value = '';
                    elements.password.focus();
                }
            }

            /**
             * Save authentication data
             */
            async function saveAuthData(data, username) {
                // Save token
                localStorage.setItem('grrc_auth_token', data.token);
                
                // Set token in API client
                if (window.apiClient.setAuthToken) {
                    window.apiClient.setAuthToken(data.token);
                }

                // Create session
                const sessionData = {
                    username: data.admin.username,
                    role: data.admin.role,
                    adminId: data.admin.id,
                    timestamp: new Date().toISOString(),
                    hasToken: true
                };
                sessionStorage.setItem('adminSession', JSON.stringify(sessionData));

                console.log('üíæ Authentication data saved');
            }

            /**
             * Verify storage writes completed
             */
            function verifyStorage(expectedToken) {
                return new Promise((resolve) => {
                    let attempts = 0;
                    
                    const checkInterval = setInterval(() => {
                        attempts++;
                        
                        const token = localStorage.getItem('grrc_auth_token');
                        const session = sessionStorage.getItem('adminSession');
                        
                        if (token && session) {
                            clearInterval(checkInterval);
                            console.log('‚úÖ Storage verified');
                            resolve(true);
                        } else if (attempts >= config.storageVerificationAttempts) {
                            clearInterval(checkInterval);
                            console.error('‚ùå Storage verification failed');
                            resolve(false);
                        }
                    }, config.storageVerificationDelay);
                });
            }

            /**
             * Handle remember me checkbox
             */
            function handleRememberMe(username) {
                if (elements.rememberMe.checked) {
                    localStorage.setItem('rememberedAdmin', username);
                } else {
                    localStorage.removeItem('rememberedAdmin');
                }
            }

            /**
             * Handle login errors
             */
            function handleLoginError(error) {
                let message = 'An error occurred during login';

                if (error.message) {
                    if (error.message.includes('credentials') || error.message.includes('Invalid')) {
                        message = 'Invalid username or password';
                    } else if (error.message.includes('Network') || error.message.includes('fetch')) {
                        message = 'Connection error. Please check your internet';
                    } else if (error.message.includes('timeout')) {
                        message = 'Connection timeout. Please try again';
                    } else if (error.message.includes('Unauthorized')) {
                        message = 'Invalid credentials';
                    } else {
                        message = error.message;
                    }
                }

                showAlert('error', message);
                setFieldError(elements.username);
                setFieldError(elements.password);
            }

            /**
             * Toggle password visibility
             */
            function togglePassword() {
                const isPassword = elements.password.type === 'password';
                elements.password.type = isPassword ? 'text' : 'password';
                elements.passwordToggle.innerHTML = isPassword ? '<span aria-hidden="true">üôà</span>' : '<span aria-hidden="true">üëÅÔ∏è</span>';
                elements.passwordToggle.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
            }

            /**
             * Show alert message
             */
            function showAlert(type, message) {
                elements.alertMessage.className = `alert alert-${type} show`;
                elements.alertText.textContent = message;
                
                const icon = type === 'error' ? '‚ö†Ô∏è' : '‚úì';
                elements.alertMessage.querySelector('.alert-icon').textContent = icon;
            }

            /**
             * Hide alert message
             */
            function hideAlert() {
                elements.alertMessage.classList.remove('show');
            }

            /**
             * Set field error state
             */
            function setFieldError(field) {
                field.classList.add('error');
            }

            /**
             * Clear field error state
             */
            function clearFieldError(field) {
                field.classList.remove('error');
                hideAlert();
            }

            /**
             * Set loading state
             */
            function setLoadingState(loading) {
                elements.loginButton.disabled = loading;
                elements.loginButton.classList.toggle('loading', loading);
                elements.username.disabled = loading;
                elements.password.disabled = loading;
                elements.rememberMe.disabled = loading;
                elements.loadingOverlay.classList.toggle('show', loading);
            }

            /**
             * Clear session data
             */
            function clearSession() {
                localStorage.removeItem('grrc_auth_token');
                sessionStorage.removeItem('adminSession');
                console.log('üóëÔ∏è Session cleared');
            }

            /**
             * Redirect to admin panel
             */
            function redirect() {
                const basePath = window.location.pathname.includes('/grrc-website/') ? '/grrc-website/' : './';
                window.location.replace(basePath + 'admin-panel.html');
            }

            // Initialize on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>