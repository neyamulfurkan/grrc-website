<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Applications - Admin Panel</title>
    
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/admin-panel.css">
</head>
<body>
    <!-- This file is loaded as an iframe in admin-panel.html -->
    
    <div class="section-content active" id="membershipApplicationsSection">
        <!-- Statistics Cards -->
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-number" id="totalApplications">0</div>
                <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingApplications">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="approvedApplications">0</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rejectedApplications">0</div>
                <div class="stat-label">Rejected</div>
            </div>
        </div>
        
        <!-- Filter Buttons -->
        <div class="admin-form" style="padding: 1.5rem; margin-bottom: 2rem;">
            <div class="filter-buttons" id="applicationStatusFilters">
                <button class="filter-btn active" data-status="all">All Applications</button>
                <button class="filter-btn" data-status="pending">Pending</button>
                <button class="filter-btn" data-status="approved">Approved</button>
                <button class="filter-btn" data-status="rejected">Rejected</button>
            </div>
        </div>
        
        <!-- Applications Table -->
        <div class="data-table-wrapper">
            <div class="table-header">
                <h3>Membership Applications</h3>
                <input type="text" class="form-input" id="applicationSearch" placeholder="&#128269; Search applications..." style="max-width: 300px;">
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Year</th>
                            <th>Applied Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: var(--space-xl);">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/api-client.js"></script>
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/utils.js"></script>
    
    <script>
        // ========== MEMBERSHIP APPLICATIONS ==========
        let currentEditApplicationId = null;
        let currentApplicationStatusFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            initializeApplications();
        });

       async function initializeApplications() {
    console.log('üîÑ Initializing membership applications iframe...');
    
    // ‚úÖ FIX: Get admin from parent OR token
    let admin = null;
    
    // Try getting from parent window first
    if (window.parent && window.parent.getCurrentAdmin) {
        admin = window.parent.getCurrentAdmin();
    }
    
    // If not found, decode token directly
    if (!admin) {
        const token = localStorage.getItem('grrc_auth_token') || sessionStorage.getItem('grrc_auth_token');
        if (token) {
            try {
                const tokenData = JSON.parse(atob(token.split('.')[1]));
                admin = {
                    id: tokenData.id || tokenData.adminId,
                    username: tokenData.username,
                    role: tokenData.role,
                    is_super_admin: tokenData.is_super_admin === true || tokenData.is_super_admin === 1,
                    permissions: tokenData.permissions || {}
                };
            } catch (e) {
                console.error('Failed to decode token:', e);
            }
        }
    }
    
    console.log('üîç Permission check:', {
        hasAdmin: !!admin,
        isSuperAdmin: admin?.is_super_admin,
        permissions: admin?.permissions
    });
    
    // ‚úÖ FIX: Super admins bypass ALL permission checks
    if (admin && (admin.is_super_admin === true || admin.is_super_admin === 1 || admin.role === 'Super Admin')) {
        console.log('‚úÖ Super admin detected - FULL ACCESS GRANTED');
        // Skip permission check entirely for super admins
    } else if (admin) {
        // Regular admin - check permissions
        const permissions = admin.permissions || {};
        if (!permissions.membership || !permissions.membership.view) {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100vh; text-align: center; padding: 2rem;">
                    <div>
                        <h2 style="color: var(--error-color); margin-bottom: 1rem;">Access Denied</h2>
                        <p style="color: var(--text-secondary);">You don't have permission to view membership applications.</p>
                    </div>
                </div>
            `;
            return;
        }
    } else {
        // No admin found at all
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; text-align: center; padding: 2rem;">
                <div>
                    <h2 style="color: var(--error-color); margin-bottom: 1rem;">Authentication Required</h2>
                    <p style="color: var(--text-secondary);">Please log in to access this page.</p>
                </div>
            </div>
        `;
        return;
    }
    
    // ‚úÖ CRITICAL FIX: Force use parent's API client and token
    if (window.parent && window.parent.apiClient) {
        window.apiClient = window.parent.apiClient;
        console.log('‚úÖ Using parent window API client');
    } else {
        // Wait for own API client
        let retries = 0;
        while ((!window.apiClient || !window.apiClient.isReady) && retries < 30) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }
    }
    
    // ‚úÖ CRITICAL: Verify token exists
    if (!window.apiClient || !window.apiClient.isReady) {
        console.error('‚ùå API client not available');
        document.getElementById('applicationsTableBody').innerHTML = 
            '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">Failed to initialize. Please refresh the page.</td></tr>';
        return;
    }
            
            if (!window.apiClient || !window.apiClient.isReady) {
                console.error('‚ùå API client not available after 5 seconds');
                document.getElementById('applicationsTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">Failed to initialize API client</td></tr>';
                return;
            }
            
            console.log('üîê API client ready, checking authentication...');
            const token = window.apiClient.getAuthToken();
            if (!token) {
                console.error('‚ùå No authentication token found');
                document.getElementById('applicationsTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">Not authenticated. Please reload the page.</td></tr>';
                return;
            }
            
            console.log('‚úÖ Authentication token found');
    
    await loadApplicationStatistics();
    await loadMembershipApplications('pending'); // ‚úÖ FIX: Load pending by default
    initializeApplicationFilters();
}

        async function loadApplicationStatistics() {
    try {
        const result = await window.apiClient.getMembershipStatistics();
        if (result.success && result.data) {
            const totalEl = document.getElementById('totalApplications');
            const pendingEl = document.getElementById('pendingApplications');
            const approvedEl = document.getElementById('approvedApplications');
            const rejectedEl = document.getElementById('rejectedApplications');
            
            if (totalEl) totalEl.textContent = result.data.total || 0;
            if (pendingEl) pendingEl.textContent = result.data.pending || 0;
            if (approvedEl) approvedEl.textContent = result.data.approved || 0;
            if (rejectedEl) rejectedEl.textContent = result.data.rejected || 0;
            
            // Update parent dashboard stat if accessible
            if (window.parent && window.parent.document.getElementById('statPendingApplications')) {
                window.parent.document.getElementById('statPendingApplications').textContent = result.data.pending || 0;
            }
        }
    } catch (error) {
        console.error('Error loading application statistics:', error);
    }
}

                async function loadMembershipApplications(status = null) {
    try {
        console.log('üìã Loading applications with status:', status);
        
        // ‚úÖ CRITICAL FIX: Re-check API client and token before EVERY request
        if (!window.apiClient || !window.apiClient.isReady) {
            console.error('‚ùå API client not ready');
            document.getElementById('applicationsTableBody').innerHTML = 
                '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">API client not initialized. Please refresh.</td></tr>';
            return;
        }
        
        const token = window.apiClient.getAuthToken();
        if (!token) {
            console.error('‚ùå No auth token found');
            document.getElementById('applicationsTableBody').innerHTML = 
                '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">Not authenticated. Please log in again.</td></tr>';
            return;
        }
        
        console.log('‚úÖ Token verified, making API call...');
        const result = await window.apiClient.getMembershipApplications(status);
                console.log('üì¶ API response:', result);
                
                const tbody = document.getElementById('applicationsTableBody');
        
        if (!tbody) {
            console.error('‚ùå Table body element not found - UI not loaded');
            return;
        }
        
        if (!result.success) {
            console.error('‚ùå API call failed:', result.error);
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">Error: ${result.error || 'Failed to load applications'}</td></tr>`;
            return;
        }
        
        if (!result.data || result.data.length === 0) {
            console.log('‚ÑπÔ∏è No applications found');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl);">No applications found</td></tr>';
            return;
        }
                
                console.log(`‚úÖ Loaded ${result.data.length} applications`);
                
                tbody.innerHTML = result.data.map(app => `
                    <tr>
                        <td style="font-weight: 600;">${app.full_name}</td>
                        <td>${app.email}</td>
                        <td>${app.department}</td>
                        <td>${app.year}</td>
                        <td>${formatDate(app.applied_date)}</td>
                        <td><span class="badge ${getApplicationStatusBadge(app.status)}">${app.status.toUpperCase()}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-icon" style="background: #3b82f6; color: white;" onclick="viewApplication('${app.id}')" title="View Details">üëÅÔ∏è</button>
                            ${app.status === 'pending' ? `
                                <button class="btn btn-icon" style="background: #10b981; color: white;" onclick="approveApplication('${app.id}')" title="Approve">‚úì</button>
                                <button class="btn btn-icon" style="background: #ef4444; color: white;" onclick="rejectApplication('${app.id}')" title="Reject">‚úï</button>
                            ` : ''}
                            <button class="btn btn-icon btn-delete" onclick="deleteApplication('${app.id}')" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('applicationsTableBody').innerHTML = 
                    '<tr><td colspan="7" style="text-align: center; padding: var(--space-xl); color: var(--error-color);">Error loading applications</td></tr>';
            }
        }

        function getApplicationStatusBadge(status) {
            const badges = {
                'pending': 'badge-warning',
                'approved': 'badge-success',
                'rejected': 'badge-error'
            };
            return badges[status] || 'badge-info';
        }

        function initializeApplicationFilters() {
            const filterButtons = document.querySelectorAll('#applicationStatusFilters .filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    const status = button.dataset.status;
                    currentApplicationStatusFilter = status === 'all' ? null : status;
                    loadMembershipApplications(currentApplicationStatusFilter);
                });
            });
            
            // Search functionality
            const searchInput = document.getElementById('applicationSearch');
            if (searchInput) {
                let debounceTimer;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        const searchTerm = e.target.value.toLowerCase();
                        const rows = document.querySelectorAll('#applicationsTableBody tr');
                        rows.forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(searchTerm) ? '' : 'none';
                        });
                    }, 300);
                });
            }
        }

        async function viewApplication(id) {
            try {
                const result = await window.apiClient.getMembershipApplicationById(id);
                if (result.success && result.data) {
                    const app = result.data;
                    
                    const modalHTML = `
                        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem;" onclick="this.remove()">
                            <div style="background: var(--surface-color); border-radius: var(--radius-lg); max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem;" onclick="event.stopPropagation()">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                    <h2 style="margin: 0; color: var(--text-primary);">Membership Application</h2>
                                    <button onclick="this.closest('div').parentElement.remove()" style="background: var(--error-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--radius-md); cursor: pointer;">Close</button>
                                </div>
                                
                                ${app.photo ? `
                                <div style="text-align: center; margin-bottom: 1.5rem;">
                                    <img src="${app.photo}" alt="${app.full_name}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); box-shadow: var(--shadow-md);">
                                </div>` : ''}
                                
                                <div style="background: var(--background-color); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Full Name</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${app.full_name}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Email</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${app.email}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Phone</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${app.phone}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Student ID</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${app.student_id || 'N/A'}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Department</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${app.department}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Year</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${app.year}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Applied Date</div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${formatDate(app.applied_date)}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Status</div>
                                            <span class="badge ${getApplicationStatusBadge(app.status)}">${app.status.toUpperCase()}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">Why they want to join:</h3>
                                    <p style="color: var(--text-secondary); line-height: 1.6;">${app.bio}</p>
                                </div>
                                
                                ${app.skills && app.skills.length > 0 ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">Skills:</h3>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                        ${(typeof app.skills === 'string' ? JSON.parse(app.skills) : app.skills).map(skill => 
                                            `<span style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-md); font-size: 0.875rem;">${skill}</span>`
                                        ).join('')}
                                    </div>
                                </div>` : ''}
                                
                                ${app.previous_experience ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">Previous Experience:</h3>
                                    <p style="color: var(--text-secondary); line-height: 1.6;">${app.previous_experience}</p>
                                </div>` : ''}
                                
                                ${app.github_profile || app.linkedin_profile ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">Social Profiles:</h3>
                                    <div style="display: flex; gap: 1rem;">
                                        ${app.github_profile ? `<a href="${app.github_profile}" target="_blank" style="color: var(--primary-color);">GitHub</a>` : ''}
                                        ${app.linkedin_profile ? `<a href="${app.linkedin_profile}" target="_blank" style="color: var(--primary-color);">LinkedIn</a>` : ''}
                                    </div>
                                </div>` : ''}
                                
                                ${app.payment_screenshot ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem;">Payment Verification:</h3>
                                    <img src="${app.payment_screenshot}" alt="Payment Screenshot" style="max-width: 100%; border-radius: var(--radius-md); border: 2px solid var(--border-color); cursor: pointer;" onclick="window.open('${app.payment_screenshot}', '_blank')">
                                    ${app.transaction_id ? `<p style="color: var(--text-secondary); margin-top: 0.5rem;">Transaction ID: <strong>${app.transaction_id}</strong></p>` : ''}
                                </div>` : ''}
                                
                                ${app.status === 'pending' ? `
                                <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <button onclick="approveApplication('${app.id}')" class="btn btn-primary" style="flex: 1;">‚úì Approve Application</button>
                                    <button onclick="rejectApplication('${app.id}')" class="btn" style="flex: 1; background: var(--error-color); color: white;">‚úï Reject Application</button>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                }
            } catch (error) {
                console.error('Error viewing application:', error);
                showToast('Error loading application details', 'error');
            }
        }

        async function approveApplication(id) {
    // Check permissions - but ALLOW super admins
    const admin = window.parent && window.parent.getCurrentAdmin ? window.parent.getCurrentAdmin() : null;
    
    if (admin) {
        // Super admins can always approve
        if (admin.is_super_admin === true || admin.is_super_admin === 1) {
            console.log('‚úÖ Super admin approving application');
        } else {
            // Check regular admin permissions
            const permissions = admin.permissions || {};
            if (!permissions.membership || !permissions.membership.approve) {
                showToast('You don\'t have permission to approve membership applications', 'error');
                return;
            }
        }
    }
            
            const notes = prompt('Add optional notes (press OK to approve):');
            if (notes === null) return;
            
            try {
                const result = await window.apiClient.approveMembershipApplication(id, notes);
                if (result.success) {
                    showToast('Application approved! Member added successfully.', 'success');
                    await loadMembershipApplications(currentApplicationStatusFilter);
                    await loadApplicationStatistics();
                    
                    // Notify parent to refresh members
                    if (window.parent && window.parent.loadMembers) {
                        window.parent.loadMembers();
                    }
                    if (window.parent && window.parent.loadDashboardStats) {
                        window.parent.loadDashboardStats();
                    }
                    
                    const modal = document.querySelector('div[style*="position: fixed"]');
                    if (modal) modal.remove();
                } else {
                    showToast(result.error || 'Failed to approve application', 'error');
                }
            } catch (error) {
                console.error('Error approving application:', error);
                showToast('Error approving application', 'error');
            }
        }

        async function rejectApplication(id) {
    // Check permissions - but ALLOW super admins
    const admin = window.parent && window.parent.getCurrentAdmin ? window.parent.getCurrentAdmin() : null;
    
    if (admin) {
        // Super admins can always reject
        if (admin.is_super_admin === true || admin.is_super_admin === 1) {
            console.log('‚úÖ Super admin rejecting application');
        } else {
            // Check regular admin permissions
            const permissions = admin.permissions || {};
            if (!permissions.membership || !permissions.membership.approve) {
                showToast('You don\'t have permission to reject membership applications', 'error');
                return;
            }
        }
    }
            
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || reason.trim() === '') {
                showToast('Rejection reason is required', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to reject this application?')) return;
            
            try {
                const result = await window.apiClient.rejectMembershipApplication(id, reason);
                if (result.success) {
                    showToast('Application rejected', 'success');
                    await loadMembershipApplications(currentApplicationStatusFilter);
                    await loadApplicationStatistics();
                    
                    const modal = document.querySelector('div[style*="position: fixed"]');
                    if (modal) modal.remove();
                } else {
                    showToast(result.error || 'Failed to reject application', 'error');
                }
            } catch (error) {
                console.error('Error rejecting application:', error);
                showToast('Error rejecting application', 'error');
            }
        }

        async function deleteApplication(id) {
    // Check permissions - but ALLOW super admins
    const admin = window.parent && window.parent.getCurrentAdmin ? window.parent.getCurrentAdmin() : null;
    
    if (admin) {
        // Super admins can always delete
        if (admin.is_super_admin === true || admin.is_super_admin === 1) {
            console.log('‚úÖ Super admin deleting application');
        } else {
            // Check regular admin permissions
            const permissions = admin.permissions || {};
            if (!permissions.membership || !permissions.membership.delete) {
                showToast('You don\'t have permission to delete applications', 'error');
                return;
            }
        }
    }
            
            if (!confirm('Are you sure you want to delete this application? This cannot be undone.')) return;
            
            try {
                const result = await window.apiClient.deleteMembershipApplication(id);
                if (result.success) {
                    showToast('Application deleted', 'success');
                    await loadMembershipApplications(currentApplicationStatusFilter);
                    await loadApplicationStatistics();
                } else {
                    showToast(result.error || 'Failed to delete application', 'error');
                }
            } catch (error) {
                console.error('Error deleting application:', error);
                showToast('Error deleting application', 'error');
            }
        }

        function showToast(message, type = 'success') {
            // Try parent window toast first
            if (window.parent && window.parent.showToast) {
                window.parent.showToast(message, type);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>